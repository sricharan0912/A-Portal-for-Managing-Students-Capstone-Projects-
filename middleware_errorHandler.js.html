<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: middleware/errorHandler.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: middleware/errorHandler.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Error Handler Middleware
 * Catches all errors from routes and sends consistent error responses
 * Must be used as the LAST middleware in index.js
 * 
 * Usage in index.js (at the end, after all routes):
 * app.use(errorHandler);
 * 
 * Note: This middleware has 4 parameters (err, req, res, next)
 * Express recognizes it as an error handler by the 4-parameter signature
 */

export const errorHandler = (err, req, res, next) => {
  const timestamp = new Date().toISOString();
  const requestId = req.id || "unknown";

  // Log error details for debugging
  console.error({
    timestamp,
    requestId,
    method: req.method,
    path: req.path,
    status: err.status || 500,
    message: err.message,
    code: err.code,
    stack: process.env.NODE_ENV === "development" ? err.stack : undefined,
  });

  // ==================== DATABASE ERRORS ====================

  // Database connection lost
  if (err.code === "PROTOCOL_CONNECTION_LOST") {
    return res.status(503).json({
      success: false,
      error: "Database connection lost. Please try again.",
      code: "DB_CONNECTION_ERROR",
    });
  }

  // Database connection limit reached
  if (err.code === "ER_CON_COUNT_ERROR") {
    return res.status(503).json({
      success: false,
      error: "Database unavailable. Too many connections. Please try again.",
      code: "DB_CONNECTION_LIMIT",
    });
  }

  // Database query syntax error
  if (err.code === "ER_PARSE_ERROR") {
    return res.status(500).json({
      success: false,
      error: "Database query error",
      code: "DB_PARSE_ERROR",
    });
  }

  // Duplicate entry (email already exists, etc.)
  if (err.code === "ER_DUP_ENTRY") {
    return res.status(409).json({
      success: false,
      error: "This resource already exists. Please use a different value.",
      code: "DUPLICATE_ENTRY",
    });
  }

  // Foreign key constraint violation
  if (err.code === "ER_NO_REFERENCED_ROW_2") {
    return res.status(400).json({
      success: false,
      error: "Invalid reference. The related resource does not exist.",
      code: "FOREIGN_KEY_ERROR",
    });
  }

  // Access denied
  if (err.code === "ER_ACCESS_DENIED_ERROR") {
    return res.status(500).json({
      success: false,
      error: "Database access error",
      code: "DB_ACCESS_ERROR",
    });
  }

  // ==================== VALIDATION ERRORS ====================

  // Joi/validation schema errors
  if (err.name === "ValidationError" || err.isJoi) {
    const details = err.details || [{ message: err.message }];
    return res.status(400).json({
      success: false,
      error: "Validation failed",
      code: "VALIDATION_ERROR",
      details: details.map(d => ({
        field: d.context?.key || d.path?.join(".") || "unknown",
        message: d.message,
      })),
    });
  }

  // ==================== JWT/AUTHENTICATION ERRORS ====================

  // Invalid JWT token format
  if (err.name === "JsonWebTokenError") {
    return res.status(401).json({
      success: false,
      error: "Invalid token",
      code: "INVALID_TOKEN",
    });
  }

  // JWT token expired
  if (err.name === "TokenExpiredError") {
    return res.status(401).json({
      success: false,
      error: "Token expired. Please login again.",
      code: "TOKEN_EXPIRED",
    });
  }

  // ==================== FIREBASE ERRORS ====================

  if (err.code &amp;&amp; err.code.startsWith("auth/")) {
    return res.status(400).json({
      success: false,
      error: mapFirebaseError(err.code),
      code: err.code,
    });
  }

  // ==================== CUSTOM APPLICATION ERRORS ====================

  // Custom errors with status code
  if (err.status &amp;&amp; err.code) {
    return res.status(err.status).json({
      success: false,
      error: err.message,
      code: err.code,
    });
  }

  // ==================== DEFAULT SERVER ERROR ====================

  res.status(500).json({
    success: false,
    error: "Internal server error. Please try again later.",
    code: "INTERNAL_SERVER_ERROR",
  });
};

/**
 * Map Firebase error codes to user-friendly messages
 * @param {string} code - Firebase error code
 * @returns {string} User-friendly error message
 */
const mapFirebaseError = (code) => {
  const errorMap = {
    "auth/email-already-exists": "Email already registered with Firebase",
    "auth/invalid-password": "Invalid password format",
    "auth/user-not-found": "User not found",
    "auth/wrong-password": "Incorrect password",
    "auth/invalid-email": "Invalid email address format",
    "auth/weak-password": "Password must be at least 6 characters",
    "auth/operation-not-allowed": "This operation is not allowed",
    "auth/too-many-requests": "Too many login attempts. Please try again later.",
    "auth/invalid-id-token": "Invalid or expired authentication token",
    "auth/user-disabled": "User account has been disabled",
    "auth/claims-too-large": "User claims are too large",
    "auth/id-token-expired": "ID token has expired",
    "auth/id-token-revoked": "ID token has been revoked",
    "auth/invalid-argument": "Invalid argument provided",
    "auth/internal-error": "Internal authentication error",
  };

  return errorMap[code] || "Authentication error occurred";
};

/**
 * Request ID Middleware
 * Generates unique ID for each request to track it through logs
 * Use this FIRST, before all other middleware
 * 
 * Usage in index.js (at the very top):
 * app.use(requestIdMiddleware);
 */
export const requestIdMiddleware = (req, res, next) => {
  // Generate unique ID: timestamp-random
  req.id = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  
  // Add to response headers so client can see it if needed
  res.setHeader("X-Request-ID", req.id);
  
  next();
};

/**
 * Request Logging Middleware
 * Logs all incoming requests for debugging and monitoring
 * 
 * Usage in index.js (after requestIdMiddleware):
 * app.use(requestLoggingMiddleware);
 */
export const requestLoggingMiddleware = (req, res, next) => {
  const start = Date.now();

  // Log request details
  console.log({
    timestamp: new Date().toISOString(),
    requestId: req.id,
    method: req.method,
    path: req.path,
    ip: req.ip || req.connection.remoteAddress,
  });

  // Override res.json to log response
  const originalJson = res.json.bind(res);
  res.json = function(data) {
    const duration = Date.now() - start;
    console.log({
      timestamp: new Date().toISOString(),
      requestId: req.id,
      method: req.method,
      path: req.path,
      status: res.statusCode,
      duration: `${duration}ms`,
      success: data?.success,
    });
    return originalJson(data);
  };

  next();
};

/**
 * Custom Application Error Class
 * Use this to throw errors from your route handlers
 * 
 * Usage in routes:
 * throw new AppError("Email already exists", 409, "DUPLICATE_EMAIL");
 */
export class AppError extends Error {
  constructor(message, status = 500, code = "ERROR") {
    super(message);
    this.status = status;
    this.code = code;
  }
}

export default errorHandler;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers_clientController.html">controllers/clientController</a></li><li><a href="module-controllers_instructorController.html">controllers/instructorController</a></li><li><a href="module-controllers_studentController.html">controllers/studentController</a></li><li><a href="module-groupFormationAlgorithm.html">groupFormationAlgorithm</a></li><li><a href="module-middleware_authMiddleware.html">middleware/authMiddleware</a></li><li><a href="module-routes_clientRoutes.html">routes/clientRoutes</a></li><li><a href="module-routes_evaluationRoutes.html">routes/evaluationRoutes</a></li><li><a href="module-routes_instructorRoutes.html">routes/instructorRoutes</a></li><li><a href="module-routes_projectRoutes.html">routes/projectRoutes</a></li><li><a href="module-routes_studentRoutes.html">routes/studentRoutes</a></li><li><a href="module-utils_groupFormationAlgorithm.html">utils/groupFormationAlgorithm</a></li></ul><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#OPTIONAL_ENV_VARS">OPTIONAL_ENV_VARS</a></li><li><a href="global.html#REQUIRED_ENV_VARS">REQUIRED_ENV_VARS</a></li><li><a href="global.html#calculatePagination">calculatePagination</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#formatAuthError">formatAuthError</a></li><li><a href="global.html#formatConflict">formatConflict</a></li><li><a href="global.html#formatCreated">formatCreated</a></li><li><a href="global.html#formatDeleted">formatDeleted</a></li><li><a href="global.html#formatError">formatError</a></li><li><a href="global.html#formatForbidden">formatForbidden</a></li><li><a href="global.html#formatList">formatList</a></li><li><a href="global.html#formatNotFound">formatNotFound</a></li><li><a href="global.html#formatServerError">formatServerError</a></li><li><a href="global.html#formatSuccess">formatSuccess</a></li><li><a href="global.html#formatUpdated">formatUpdated</a></li><li><a href="global.html#formatValidationError">formatValidationError</a></li><li><a href="global.html#getEnv">getEnv</a></li><li><a href="global.html#isValidEmail">isValidEmail</a></li><li><a href="global.html#isValidUrl">isValidUrl</a></li><li><a href="global.html#mapFirebaseError">mapFirebaseError</a></li><li><a href="global.html#printEnvironmentSummary">printEnvironmentSummary</a></li><li><a href="global.html#printExampleEnvFile">printExampleEnvFile</a></li><li><a href="global.html#requestIdMiddleware">requestIdMiddleware</a></li><li><a href="global.html#requestLoggingMiddleware">requestLoggingMiddleware</a></li><li><a href="global.html#server">server</a></li><li><a href="global.html#validateClientLogin">validateClientLogin</a></li><li><a href="global.html#validateClientSignup">validateClientSignup</a></li><li><a href="global.html#validateDatabaseConfig">validateDatabaseConfig</a></li><li><a href="global.html#validateEnvironment">validateEnvironment</a></li><li><a href="global.html#validateFirebaseConfig">validateFirebaseConfig</a></li><li><a href="global.html#validateGroupAssignment">validateGroupAssignment</a></li><li><a href="global.html#validateInstructorLogin">validateInstructorLogin</a></li><li><a href="global.html#validateInstructorSignup">validateInstructorSignup</a></li><li><a href="global.html#validatePreferences">validatePreferences</a></li><li><a href="global.html#validateProject">validateProject</a></li><li><a href="global.html#validateStudentLogin">validateStudentLogin</a></li><li><a href="global.html#validateStudentSignup">validateStudentSignup</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Mon Dec 22 2025 21:57:37 GMT-0500 (Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
